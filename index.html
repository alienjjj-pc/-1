<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-7-8 å‘¼å¸æ³•å¼•å°å·¥å…· V6.4 æœ€çµ‚æ’ç‰ˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-blue-start: #2a63a8; 
            --color-blue-end: #4a90e2;   
            --color-green-start: #4CAF50; 
            --color-green-end: #6aa84f;   
            --text-gradient-start-blue: #89CFF0; 
            --text-gradient-end-green: #90EE90; 
        }

        body {
            font-family: 'Noto Sans TC', sans-serif; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            padding: 1rem;
            background-color: #0a192f; 
            color: white; 
        }
        
        #breathing-area {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative; 
            width: 100%;
        }

        .breathing-ball {
            position: absolute; 
            top: 50%;
            left: 50%;
            /* åœ“çƒçš„æ ¸å¿ƒç½®ä¸­é‚è¼¯ */
            transform: translate(-50%, -50%) scale(1.0); 

            transition-property: all;
            transition-timing-function: ease-in-out;
            /* åœ“çƒå°ºå¯¸ä½¿ç”¨ vw å–®ä½ï¼Œå·²ç¢ºä¿é©æ‡‰è¢å¹• */
            width: 50vw;  
            height: 50vw; 
            max-width: 300px; 
            max-height: 300px; 
            
            background: linear-gradient(135deg, var(--color-blue-start), var(--color-blue-end));
            box-shadow: 
                0 0 10px rgba(74, 144, 226, 0.8), 
                0 0 20px rgba(74, 144, 226, 0.6), 
                0 0 40px rgba(74, 144, 226, 0.4), 
                0 0 60px rgba(74, 144, 226, 0.2); 
            
            z-index: 10; 
        }

        .breathing-ball.inhaled {
            background: linear-gradient(135deg, var(--color-green-start), var(--color-green-end));
            box-shadow: 
                0 0 10px rgba(76, 175, 80, 0.8),
                0 0 20px rgba(76, 175, 80, 0.6),
                0 0 40px rgba(76, 175, 80, 0.4),
                0 0 60px rgba(76, 175, 80, 0.2);
        }
        
        .high-z-index {
            z-index: 20;
            position: relative; 
        }
        
        /* å‘¼å¸æ–‡å­—æç¤ºï¼šæ‡¸æµ®æ–¼åœ“çƒæ­£ä¸Šæ–¹ */
        #instruction-text {
            font-size: 3.5rem; 
            font-weight: 300; 
            background-image: linear-gradient(to right, var(--text-gradient-end-green), var(--text-gradient-start-blue)); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent; 
            transition: all 0.5s ease-in-out; 
            
            position: absolute;
            top: 35%; /* ç¢ºä¿è·é›¢åœ“çƒé ‚éƒ¨æœ‰è¶³å¤ çš„ç©ºé–“ */
            left: 50%;
            transform: translateX(-50%); 
            text-align: center;
        }
        
        /* ç§’æ•¸å€’æ•¸ï¼šå®Œç¾ç½®ä¸­åœ¨åœ“çƒä¸­å¿ƒ */
        #countdown-text {
            font-size: 8rem; 
            font-weight: 700; 
            background-image: linear-gradient(to right, var(--text-gradient-end-green), var(--text-gradient-start-blue)); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent; 
            transition: all 0.5s ease-in-out; 
            
            position: absolute;
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%); 
            text-align: center;
        }
        
        /* éœéŸ³é–‹é—œå®šä½ */
        #sound-toggle {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s;
            z-index: 100; 
        }

        #toggle-button {
             z-index: 30;
             margin-top: 5rem; 
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-sea-blue': '#0a192f',
                        'spotify-green': '#1DB954', 
                        'youtube-red': '#FF0000', 
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-deep-sea-blue text-white">

    <div id="sound-toggle" onclick="toggleMute()">
        <span id="sound-icon" class="text-3xl high-z-index">ğŸ”Š</span>
    </div>

    <div id="breathing-area">
        <div id="instruction-text" class="high-z-index">
            é»æ“Šé–‹å§‹
        </div>

        <div id="countdown-text" class="high-z-index opacity-0">
            
        </div>

        <div id="breathing-ball" 
             class="breathing-ball rounded-full flex-shrink-0">
        </div>
    </div>
    <button id="toggle-button" 
            class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-xl rounded-full shadow-lg transition duration-300 high-z-index"
            onclick="toggleBreathing()">
        é–‹å§‹å‘¼å¸
    </button>
    
    <script>
        const ball = document.getElementById('breathing-ball');
        const text = document.getElementById('instruction-text');
        const countdownText = document.getElementById('countdown-text');
        const button = document.getElementById('toggle-button');
        const soundIcon = document.getElementById('sound-icon');
        
        let isRunning = false;
        let intervalId;       
        let isMuted = false; 
        let pulseIntervalId; 
        
        const TIMES = { IN: 4, HOLD: 7, OUT: 8 }; 
        const SCALE_MIN = 0.8; 
        const SCALE_MAX = 1.5; 
        const PULSE_MIN_SCALE = 1.0; 
        const PULSE_MAX_SCALE = 1.03; 
        const PULSE_SPEED = 0.001; 
        const totalCycles = 99;

        const BLUE_START = getComputedStyle(document.documentElement).getPropertyValue('--color-blue-start');
        const BLUE_END = getComputedStyle(document.documentElement).getPropertyValue('--color-blue-end');
        const GREEN_START = getComputedStyle(document.documentElement).getPropertyValue('--color-green-start');
        const GREEN_END = getComputedStyle(document.documentElement).getPropertyValue('--color-green-end');

        let audioContext = null;

        function setTransitionDuration(seconds) {
            ball.style.transitionDuration = `${seconds}s`;
        }
        
        function ensureAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    isMuted = true;
                    soundIcon.textContent = "ğŸ”‡"; 
                    return false;
                }
            }
            return true;
        }
        
        function generateDingSound() {
            if (isMuted || !audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05); 
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);   
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime); 
            oscillator.type = 'sine';
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function toggleMute() {
            ensureAudioContext(); 
            isMuted = !isMuted;
            if (isMuted) {
                soundIcon.textContent = "ğŸ”‡"; 
            } else {
                soundIcon.textContent = "ğŸ”Š"; 
                if (audioContext) generateDingSound(); 
            }
        }
        
        function startPulse() {
            let isGrowing = true;
            let currentPulseScale = PULSE_MIN_SCALE;
            
            setTransitionDuration(0); 

            pulseIntervalId = setInterval(() => {
                if (!isRunning) {
                    clearInterval(pulseIntervalId);
                    return;
                }
                if (isGrowing) {
                    currentPulseScale += PULSE_SPEED;
                    if (currentPulseScale >= PULSE_MAX_SCALE) {
                        isGrowing = false;
                    }
                } else {
                    currentPulseScale -= PULSE_SPEED;
                    if (currentPulseScale <= PULSE_MIN_SCALE) {
                        isGrowing = true;
                    }
                }
                ball.style.transform = `translate(-50%, -50%) scale(${SCALE_MAX * currentPulseScale})`;
            }, 20); 
        }
        
        function stopPulse() {
            clearInterval(pulseIntervalId);
        }

        function startCountdown(duration, nextPhaseCallback) {
            let timeLeft = duration;
            countdownText.classList.remove('opacity-0');
            countdownText.textContent = timeLeft;
            clearInterval(intervalId);
            intervalId = setInterval(() => {
                timeLeft--;
                countdownText.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(intervalId);
                    countdownText.classList.add('opacity-0');
                    nextPhaseCallback();
                }
            }, 1000);
        }

        // --- æ ¸å¿ƒå‘¼å¸å¾ªç’°é‚è¼¯ ---
        
        function inhale() {
            if (!isRunning) return;
            
            generateDingSound(); 
            text.textContent = "é–‹å§‹å¸æ°£"; 
            
            ball.style.background = `linear-gradient(135deg, var(--color-blue-start), var(--color-blue-end))`;
            ball.classList.remove('inhaled'); 
            ball.style.transform = `translate(-50%, -50%) scale(${SCALE_MIN})`; 

            requestAnimationFrame(() => {
                text.textContent = "å¸æ°£ä¸­"; 
                setTransitionDuration(TIMES.IN); 
                ball.style.background = `linear-gradient(135deg, var(--color-green-start), var(--color-green-end))`;
                ball.classList.add('inhaled'); 
                ball.style.transform = `translate(-50%, -50%) scale(${SCALE_MAX})`; 
                startCountdown(TIMES.IN, hold);
            });
        }

        function hold() {
            if (!isRunning) return;
            generateDingSound(); 

            text.textContent = "æ†‹æ°£"; 
            setTransitionDuration(0.01); 
            ball.style.transform = `translate(-50%, -50%) scale(${SCALE_MAX})`; 
            ball.style.background = `linear-gradient(135deg, var(--color-green-start), var(--color-green-end))`;
            ball.classList.add('inhaled'); 
            startPulse(); 
            startCountdown(TIMES.HOLD, exhale);
        }

        function exhale() {
            if (!isRunning) return;
            stopPulse(); 
            generateDingSound(); 

            text.textContent = "åæ°£ä¸­"; 
            setTransitionDuration(TIMES.OUT); 
            
            ball.style.background = `linear-gradient(135deg, var(--color-blue-start), var(--color-blue-end))`;
            ball.classList.remove('inhaled'); 
            ball.style.transform = `translate(-50%, -50%) scale(${SCALE_MIN})`; 

            let countdownEndTime = TIMES.OUT * 1000;
            setTimeout(() => {
                if (isRunning) {
                     text.textContent = "éŠœæ¥å¸æ°£"; 
                }
            }, countdownEndTime);

            startCountdown(TIMES.OUT, inhale);
        }

        // --- æ§åˆ¶é‚è¼¯ ---
        function startBreathing() {
            if (isRunning) return;
            
            try {
                 ensureAudioContext(); 
            } catch (e) {
                 console.error("Audio initialization failed.", e);
            }
            
            isRunning = true;
            button.textContent = "åœæ­¢";
            
            ball.style.background = `linear-gradient(135deg, var(--color-blue-start), var(--color-blue-end))`;
            ball.classList.remove('inhaled');
            ball.style.transform = `translate(-50%, -50%) scale(${SCALE_MIN})`;

            requestAnimationFrame(inhale);
        }

        function stopBreathing() {
            isRunning = false;
            
            clearInterval(intervalId);
            stopPulse(); 

            countdownText.classList.add('opacity-0');
            countdownText.textContent = ''; 
            
            // ã€V6.4 æ–‡æœ¬ä¿®æ­£ã€‘ç§»é™¤...
            text.textContent = "å·²æš«åœï¼Œé»æ“Šé–‹å§‹"; 
            button.textContent = "é–‹å§‹å‘¼å¸";
            
            setTransitionDuration(0.5); 
            ball.style.background = `linear-gradient(135deg, var(--color-blue-start), var(--color-blue-end))`;
            ball.classList.remove('inhaled');
            ball.style.transform = `translate(-50%, -50%) scale(${SCALE_MIN})`;
        }

        function toggleBreathing() {
            if (isRunning) {
                stopBreathing();
            } else {
                startBreathing();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTransitionDuration(TIMES.IN);
            // ã€V6.4 æ–‡æœ¬ä¿®æ­£ã€‘ç§»é™¤...
            text.textContent = "é»æ“Šé–‹å§‹";
        });
        
    </script>
</body>
</html>
